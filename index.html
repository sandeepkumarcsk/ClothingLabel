<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Label Generator (Fixed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.svg" type="image/svg+xml">

  <style>
    body{font-family:Inter,system-ui,sans-serif;margin:24px;background:#f8fafc;color:#0b1220}
    .card{max-width:760px;margin:0 auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.06)}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px}
    label{font-size:13px;color:#374151;font-weight:600}
    input[type="number"]{padding:10px;border-radius:8px;border:1px solid #e6edf3;width:120px}
    button{padding:10px 16px;border-radius:10px;border:0;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{background:#94a3b8;cursor:not-allowed}
    .note{font-size:13px;color:#475569;margin-top:8px}
    
    /* FIX: Make renderer visible to browser but behind content, so html2canvas doesn't fail */
    .hidden-renderer {
      position: absolute;
      top: 0;
      left: 0;
      z-index: -100;
      opacity: 0.01; /* Not 0, or browsers ignore it */
      pointer-events: none;
    }

    #status { margin-top:10px; font-weight:600; font-size:14px; }
    #debug-log { font-family:monospace; font-size:11px; color:red; margin-top:10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>2 × 2 Label Generator (Robust)</h1>
    <p class="note">Enter values and click <strong>Generate PDF</strong>.</p>

    <div class="row" style="margin-top:14px;">
      <div>
        <label for="price">Purchase Price</label><br>
        <input id="price" type="number" min="0" step="0.01" placeholder="200" />
      </div>

      <div>
        <label for="margin">Margin %</label><br>
        <input id="margin" type="number" min="0" value="50" />
      </div>

      <div>
        <label for="qty">Quantity</label><br>
        <input id="qty" type="number" min="1" max="500" value="1" />
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;">
        <button id="generatePdf">Generate PDF</button>
      </div>
    </div>
    
    <div id="status"></div>
    <div id="debug-log"></div>
  </div>

  <div id="labelRenderer" class="hidden-renderer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" onerror="logError('Failed to load QRCode lib')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="logError('Failed to load html2canvas')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="logError('Failed to load jsPDF')"></script>

  <script>
    // Helper to show errors on screen
    function logError(msg) {
      console.error(msg);
      document.getElementById('debug-log').textContent += "Error: " + msg + "\n";
    }

    if ('serviceWorker' in navigator) {
      // Unregister old workers to force update
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) { registration.unregister(); }
      });
    }

    (function(){
      const digitToLetter = { '0':'J','1':'A','2':'B','3':'C','4':'D','5':'E','6':'F','7':'G','8':'H','9':'I' };
      const priceInput = document.getElementById('price');
      const marginInput = document.getElementById('margin');
      const qtyInput = document.getElementById('qty');
      const generateBtn = document.getElementById('generatePdf');
      const statusEl = document.getElementById('status');
      const labelRenderer = document.getElementById('labelRenderer');

      function toItemCode(price){
        const digits = String(price).replace(/\D/g,'');
        if(!digits) return '';
        return digits.split('').map(d => digitToLetter[d] || '?').join('');
      }

      function formatCurrency(n){ return '₹' + Number(n).toFixed(2); }
      function makeSerial() {
        const c = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let r = ''; for (let i=0; i<8; i++) r += c.charAt(Math.floor(Math.random()*c.length));
        return r;
      }

      // We use 192px which is exactly 2 inches at 96 DPI
      const LABEL_SIZE_PX = 192; 

      function createHiddenLabelDOM({ itemCode, sellingPrice, serial, idx }){
        const wrapper = document.createElement('div');
        // Explicit pixel sizes are safer for html2canvas
        wrapper.style.width = LABEL_SIZE_PX + 'px';
        wrapper.style.height = LABEL_SIZE_PX + 'px';
        wrapper.style.boxSizing = 'border-box';
        wrapper.style.padding = '8px';
        wrapper.style.display = 'flex';
        wrapper.style.flexDirection = 'column';
        wrapper.style.alignItems = 'center';
        wrapper.style.justifyContent = 'space-between';
        wrapper.style.background = '#ffffff';
        wrapper.style.color = '#0b1220';
        
        // 1. QR
        const qrWrap = document.createElement('div');
        qrWrap.id = 'qr-' + idx;
        // 0.9 inch approx 86px
        qrWrap.style.width = '86px';
        qrWrap.style.height = '86px';
        wrapper.appendChild(qrWrap);

        // 2. Serial
        const serialEl = document.createElement('div');
        serialEl.textContent = serial;
        serialEl.style.fontSize = '12px';
        serialEl.style.fontWeight = '600';
        serialEl.style.color = '#334155';
        serialEl.style.marginTop = '4px';
        wrapper.appendChild(serialEl);

        // 3. Code
        const codeEl = document.createElement('div');
        codeEl.textContent = itemCode || '-';
        codeEl.style.fontWeight = '700';
        wrapper.appendChild(codeEl);

        // 4. Price
        const priceEl = document.createElement('div');
        priceEl.innerHTML = 'Selling Price: <b>' + formatCurrency(sellingPrice) + '</b>';
        priceEl.style.fontSize = '12px';
        wrapper.appendChild(priceEl);

        new QRCode(qrWrap, {
          text: serial,
          width: 86,
          height: 86,
          correctLevel: QRCode.CorrectLevel.H
        });
        return wrapper;
      }

      async function generatePdf(){
        try {
          const purchasePrice = Number(priceInput.value);
          const marginPercent = Number(marginInput.value);
          let qty = parseInt(qtyInput.value, 10);

          if(!priceInput.value || purchasePrice < 0) return alert('Invalid Purchase Price');
          if(isNaN(qty) || qty < 1) return alert('Invalid Quantity');
          
          generateBtn.disabled = true;
          statusEl.textContent = 'Initializing...';
          statusEl.style.color = '#0b1220';

          // Check libs
          if(!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF library not loaded");
          if(!window.html2canvas) throw new Error("html2canvas library not loaded");

          const pdf = new window.jspdf.jsPDF({ unit: 'px', format: [LABEL_SIZE_PX, LABEL_SIZE_PX] });
          const itemCode = toItemCode(purchasePrice);
          const sellingPrice = purchasePrice * (1 + (marginPercent/100));

          for(let i=1; i<=qty; i++){
            statusEl.textContent = `Processing label ${i}/${qty}...`;
            
            labelRenderer.innerHTML = '';
            const serial = makeSerial();
            const labelDOM = createHiddenLabelDOM({ itemCode, sellingPrice, serial, idx: i });
            labelRenderer.appendChild(labelDOM);

            // Wait for DOM render
            await new Promise(r => setTimeout(r, 100));

            const canvas = await html2canvas(labelDOM, {
              scale: 2, // High res
              backgroundColor: '#ffffff',
              logging: false,
              useCORS: true
            });

            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, LABEL_SIZE_PX, LABEL_SIZE_PX);

            if(i < qty) pdf.addPage([LABEL_SIZE_PX, LABEL_SIZE_PX]);
          }

          const filename = `Labels-${Date.now()}.pdf`;
          pdf.save(filename);
          statusEl.textContent = `Success! Downloaded ${filename}`;
          statusEl.style.color = 'green';

        } catch(err) {
          logError(err.message || err);
          statusEl.textContent = 'Failed. Check debug log below.';
          statusEl.style.color = 'red';
        } finally {
          generateBtn.disabled = false;
        }
      }

      generateBtn.addEventListener('click', generatePdf);
    })();
  </script>
</body>
</html>
